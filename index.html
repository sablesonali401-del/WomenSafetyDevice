<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Women Safety Device</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="card">
        <h1>🚨 Women Safety Device</h1>
        <p>Help me! I need help! — share location via SMS</p>

        <button id="sosBtn">Send SOS Alert</button>
        <p id="status" class="muted"></p>

        <hr />
        <h3>Recent Alerts</h3>
        <ul id="history"></ul>
    </div>

<script>
async function loadHistory() {
    try {
        const res = await fetch('/history');
        const j = await res.json();
        const list = document.getElementById('history');
        list.innerHTML = '';
        if (j.status === 'success' && j.data.length) {
            j.data.slice(0,5).forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${new Date(item.sent_at).toLocaleString()} — ${item.status} — ${item.latitude}, ${item.longitude}`;
                list.appendChild(li);
            });
        } else {
            list.innerHTML = '<li>No alerts yet</li>';
        }
    } catch (e) {
        console.log('History load error', e);
    }
}

document.getElementById('sosBtn').addEventListener('click', () => {
    const statusEl = document.getElementById('status');
    statusEl.textContent = 'Getting GPS location…';

    if (!navigator.geolocation) {
        statusEl.textContent = '❌ Geolocation not supported in this browser.';
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        // 🔹 Reverse geocode (lat/lon → human-readable address)
        let address = "Unknown location";
        try {
            const resGeo = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
            const dataGeo = await resGeo.json();
            if (dataGeo.display_name) {
                address = dataGeo.display_name;
            }
        } catch (err) {
            console.error("Reverse geocoding failed:", err);
        }

        const payload = {
            latitude: lat,
            longitude: lon,
            accuracy: accuracy,
            address: address   // 👈 now sending address too
        };

        statusEl.textContent = `Sending SOS… (Accuracy: ${accuracy}m)`;

        try {
            const res = await fetch('/send_sos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const j = await res.json();
            if (res.ok) {
                statusEl.innerHTML = `✅ ${j.message}<br>
                    📍 <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank">View Location</a><br>
                    🏠 ${address}<br>
                    (Accuracy: ${accuracy}m)`;
                loadHistory();
            } else {
                statusEl.textContent = j.message || 'Failed to send SOS';
            }
        } catch (err) {
            statusEl.textContent = '❌ Network error sending SOS';
            console.error(err);
        }
    }, (err) => {
        statusEl.textContent = '❌ Could not get location: ' + err.message;
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
});

// Load history when page opens
loadHistory();
</script>
</body>
</html>
